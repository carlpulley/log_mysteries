<%
def walk_tree(node)
	parent_label = "#{node.http[:verb]} #{node.http[:uri]} #{node.counter} #{node.processing_time}"
	origin_label = node.observed_time("%H:%M:%S")
	result = {}
	if node.leaf?
		result[parent_label] = node.result
	else
		result[parent_label] ||= {}
		node.children.each do |child|
			child_label = "#{child.http[:verb]} #{child.http[:uri]} #{child.counter} #{child.processing_time}"
			result[parent_label][origin_label] ||= {}
			result[parent_label][origin_label][child.pid] ||= {}
			if child.leaf?
				result[parent_label][origin_label][child.pid][child_label] = child.result
			else
				result[parent_label][origin_label][child.pid] = walk_tree child
			end
		end
	end
	result
end
%>
<script type="text/javascript+protovis">	
	<% log_events.order(:observed_at).all.map { |d| d.root }.uniq.each do |root| %>
		var root = <%=raw root.observed_time("%d/%b/%Y %H:%M:%S %Z").to_json %>;
		var data = <%=raw walk_tree(root).to_json %>;
		
		<%= render :partial => 'report/graph/dendrogram.js' %>
		
		vis.left(150)
		   .right(500)
		   .width(650)
		   .top(0)
		   .bottom(0)
		   .height(<%= root.self_and_descendants.count*15 %>);
		
		dot.fillStyle(function(n) n.firstChild ? "#aec7e8" : pv.Scale.linear(200, 300, 400, 600).range('green', 'yellow', 'red', 'black')(n.nodeValue))
		   .text(<%=raw root.observed_time("%d/%b/%Y %H:%M:%S %Z").to_json %>);
		
		//layout.label.add(function() sparklength(15,20)).top(0);
		//layout.label.add(pv.Label);

		vis.render();
	<% end %>
</script>

<%
def walk_tree(node)
	if node.root? and node.leaf?
		"'#{node.http[:verb]} #{node.http[:uri]} #{node.pid} #{node.thread_index} #{node.counter} #{node.processing_time}': #{node.result}"
	elsif node.leaf?
		"'#{node.http[:verb]} #{node.http[:uri]} #{node.pid} #{node.thread_index} #{node.counter} #{node.processing_time}': #{node.result}"
	else
		"'#{node.http[:verb]} #{node.http[:uri]} #{node.pid} #{node.thread_index} #{node.counter} #{node.processing_time}': { #{node.children.sort { |a,b| a.counter <=> b.counter }.map { |n| walk_tree n }.join(", ")} }"
	end
end
%>
<script type="text/javascript+protovis">	
	<% log_events.order(:observed_at).all.map { |d| d.root }.uniq.each do |root| %>
		var root = "<%= root.observed_at %>";
		var data = { '<%= root.remote %>': { <%= walk_tree(root) %> } };
		
		<%= render :partial => 'report/graph/dendrogram.js' %>
		
		vis.left(150)
		   .right(500)
		   .width(650)
		   .top(0)
		   .bottom(0)
		   .height(<%= root.self_and_descendants.count*12 %>);
		
		dot.fillStyle(function(n) n.firstChild ? "#aec7e8" : pv.Scale.linear(200, 300, 400, 600).range('green', 'yellow', 'red', 'black')(n.nodeValue));
		
		//layout.label.add(function() sparklength(15,20)).top(0);
		//layout.label.add(pv.Label);

		vis.render();
	<% end %>
</script>
